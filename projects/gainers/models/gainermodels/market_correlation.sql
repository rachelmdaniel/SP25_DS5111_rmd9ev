{{ config(materialized='table') }}

WITH combined_data AS (
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250325_163817' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250325_163817
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250325_202638' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250325_202638
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250326_170820' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250326_170820
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250326_203022' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250326_203022
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250327_133155' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250327_133155
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250327_163048' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250327_163048
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250327_200143' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250327_200143
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250328_133150' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250328_133150
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250328_200202' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250328_200202
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250402_163039' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250402_163039
    UNION ALL
    SELECT symbol, price_change, 'WSJGAINERS_NORM_20250402_200147' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.WSJGAINERS_NORM_20250402_200147
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250325_163027' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250325_163027
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250325_202638' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250325_202638
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250326_133135' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250326_133135
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250326_163023' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250326_163023
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250326_200138' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250326_200138
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250327_133152' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250327_133152
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250327_163041' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250327_163041
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250327_200137' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250327_200137
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250328_133144' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250328_133144
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250328_163035' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250328_163035
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250328_200202' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250328_200202
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250402_133132' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250402_133132
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250402_163037' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250402_163037
    UNION ALL
    SELECT symbol, price_change, 'YGAINERS_NORM_20250402_200142' AS TABLE_NAME FROM DATA_SCIENCE.RMD9EV_RAW.YGAINERS_NORM_20250402_200142
),

extracted_data AS (
    SELECT
        TO_DATE(REGEXP_SUBSTR(TABLE_NAME, '[0-9]{8}'), 'YYYYMMDD') AS extracted_date,
        symbol,
        price_change
    FROM combined_data
),

daily_market_avg AS (
    SELECT
        extracted_date,
        AVG(price_change) AS avg_market_price_change
    FROM extracted_data
    GROUP BY extracted_date
),

stock_vs_market AS (
    SELECT
        s.symbol,
        s.extracted_date,
        s.price_change,
        m.avg_market_price_change
    FROM extracted_data s
    JOIN daily_market_avg m
      ON s.extracted_date = m.extracted_date
),

stock_market_corr AS (
    SELECT
        symbol,
        CORR(price_change, avg_market_price_change) AS correlation
    FROM stock_vs_market
    GROUP BY symbol
)

SELECT
    symbol,
    CASE
        WHEN ABS(correlation) > 0.5 THEN 'Y'
        ELSE 'N'
    END AS Market_correlation
FROM stock_market_corr
